"use client";

import { useState } from "react";
import {
    Trash2,
    Database,
    RefreshCcw,
    ShieldAlert,
    Save,
    Info,
    Key,
    Search,
    UserCircle2,
    Check,
    X,
    Loader2,
    Camera,
    Mail,
    Phone,
    Upload,
    HelpCircle,
    RotateCcw,
    Hammer,
    Bell,
    Settings2,
    ClipboardList,
    Clock,
    Calendar,
    Plus,
    Star
} from "lucide-react";
import axios from "axios";
import { motion, AnimatePresence } from "framer-motion";
import { useEffect, useCallback } from "react";
import { useConfig } from "@/context/ConfigContext";
import Swal from 'sweetalert2';
import { useTour } from "@/components/tour";
import { configuracionTour } from "@/components/tour/tourSteps";
import { useRouter } from "next/navigation";

const ConfiguracionEvento = () => {
    const { nombreAsamblea, fechaAsamblea, updateConfig } = useConfig();
    const [nombre, setNombre] = useState(nombreAsamblea);
    const [fecha, setFecha] = useState(fechaAsamblea);
    const [saving, setSaving] = useState(false);

    useEffect(() => {
        setNombre(nombreAsamblea);
        setFecha(fechaAsamblea);
    }, [nombreAsamblea, fechaAsamblea]);

    const handleSave = async () => {
        setSaving(true);
        try {
            await updateConfig("ASAMBLEA_NOMBRE", nombre);
            await updateConfig("ASAMBLEA_FECHA", fecha);

            Swal.fire({
                title: '¬°Configuraci√≥n Guardada!',
                text: 'Los par√°metros del evento se han actualizado y sincronizado con el sistema.',
                icon: 'success',
                confirmButtonText: 'Excelente',
                confirmButtonColor: '#10b981',
                padding: '2em',
                customClass: {
                    popup: 'rounded-[2rem] shadow-2xl'
                }
            });
        } catch (error) {
            Swal.fire({
                title: 'Error al Guardar',
                text: 'Hubo un problema al intentar actualizar la configuraci√≥n. Verifica tu conexi√≥n.',
                icon: 'error',
                confirmButtonText: 'Intentar De Nuevo',
                confirmButtonColor: '#ef4444',
                padding: '2em',
                customClass: {
                    popup: 'rounded-[2rem] shadow-2xl'
                }
            });
        } finally {
            setSaving(false);
        }
    };

    return (
        <>
            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2 italic uppercase">
                <Save className="h-5 w-5 text-emerald-500" />
                Par√°metros del Evento
            </h2>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                    <label className="text-xs font-black text-slate-500 uppercase">Nombre de la Asamblea</label>
                    <input
                        type="text"
                        value={nombre}
                        onChange={(e) => setNombre(e.target.value)}
                        className="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm focus:border-emerald-500 outline-none transition-all font-medium"
                    />
                </div>
                <div className="space-y-2">
                    <label className="text-xs font-black text-slate-500 uppercase">Fecha del Evento</label>
                    <input
                        type="date"
                        value={fecha}
                        onChange={(e) => setFecha(e.target.value)}
                        className="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm focus:border-emerald-500 outline-none transition-all font-medium"
                    />
                </div>
            </div>

            <div className="flex justify-end pt-4">
                <button
                    onClick={handleSave}
                    disabled={saving}
                    className="rounded-xl bg-slate-900 px-8 py-3 font-bold text-white hover:bg-black shadow-lg shadow-slate-200 transition-all active:scale-95 disabled:opacity-50"
                >
                    {saving ? "Guardando..." : "Guardar Configuraci√≥n"}
                </button>
            </div>
        </>
    );
};

// Componente de Mantenimiento (Compacto)
const ConfiguracionMantenimiento = () => {
    const { isMaintenanceMode, updateConfig } = useConfig();
    const [enabled, setEnabled] = useState(isMaintenanceMode);
    const [saving, setSaving] = useState(false);

    useEffect(() => {
        setEnabled(isMaintenanceMode);
    }, [isMaintenanceMode]);

    const handleToggle = async () => {
        const newValue = !enabled;
        setSaving(true);
        try {
            await updateConfig("MODO_MANTENIMIENTO", newValue ? "true" : "false");
            setEnabled(newValue);

            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
            Toast.fire({
                icon: newValue ? 'warning' : 'success',
                title: newValue ? 'Modo Mantenimiento Activo' : 'Sistema Disponible'
            });
        } catch (error) {
            console.error(error);
        } finally {
            setSaving(false);
        }
    };

    return (
        <div className="flex items-center justify-between p-4 rounded-xl border border-slate-100 bg-white hover:border-slate-200 transition-colors">
            <div className="flex items-center gap-4">
                <div className={`p-2.5 rounded-lg transition-colors ${enabled ? 'bg-amber-500 text-white' : 'bg-slate-100 text-slate-400'}`}>
                    <Hammer className="h-5 w-5" />
                </div>
                <div>
                    <h3 className="text-sm font-bold text-slate-800">Modo Mantenimiento</h3>
                    <p className="text-xs text-slate-500">Bloquea el acceso a usuarios est√°ndar.</p>
                </div>
            </div>

            <button
                onClick={handleToggle}
                disabled={saving}
                className={`relative inline-flex h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${enabled ? 'bg-amber-500' : 'bg-slate-300'}`}
            >
                <span className={`pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${enabled ? 'translate-x-5' : 'translate-x-0'}`}>
                    {saving && <Loader2 className="h-4 w-4 m-1 animate-spin text-amber-500" />}
                </span>
            </button>
        </div>
    );
};

// Componente para Notificaciones de Asignaci√≥n (Compacto)
const ConfiguracionNotificaciones = () => {
    const { updateConfig } = useConfig();
    const [enabled, setEnabled] = useState(true);
    const [saving, setSaving] = useState(false);
    const [loaded, setLoaded] = useState(false);

    useEffect(() => {
        const fetchConfig = async () => {
            try {
                const token = localStorage.getItem("token");
                const res = await axios.get("/api/configuracion", {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = res.data;
                if (Array.isArray(data)) {
                    const config = data.find((c: any) => c.clave === "notificaciones_asignacion_activas");
                    if (config) setEnabled(config.valor !== "false");
                } else if (data && typeof data === 'object') {
                    if (data.notificaciones_asignacion_activas !== undefined) {
                        setEnabled(data.notificaciones_asignacion_activas !== "false");
                    }
                }
            } catch (error) {
                console.error("Error loading notification config:", error);
            } finally {
                setLoaded(true);
            }
        };
        fetchConfig();
    }, []);

    const handleToggle = async () => {
        const newValue = !enabled;
        setSaving(true);
        try {
            await updateConfig("notificaciones_asignacion_activas", newValue ? "true" : "false");
            setEnabled(newValue);

            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
            Toast.fire({
                icon: newValue ? 'success' : 'info',
                title: newValue ? 'Notificaciones Activadas' : 'Notificaciones Desactivadas'
            });
        } catch (error) {
            console.error(error);
        } finally {
            setSaving(false);
        }
    };

    const handleTestNotification = async () => {
        if (!("Notification" in window)) return;
        if (Notification.permission === "default") await Notification.requestPermission();

        const notification = new Notification("üîî Nueva Asignaci√≥n", {
            body: "Prueba de notificaci√≥n de sistema",
            icon: "/logo.png",
            tag: "test-" + Date.now()
        });
        notification.onclick = () => window.focus();
    };

    if (!loaded) return null;

    return (
        <div className="flex items-center justify-between p-4 rounded-xl border border-slate-100 bg-white hover:border-slate-200 transition-colors">
            <div className="flex items-center gap-4">
                <div className={`p-2.5 rounded-lg transition-colors ${enabled ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-400'}`}>
                    <Bell className="h-5 w-5" />
                </div>
                <div>
                    <h3 className="text-sm font-bold text-slate-800">Avisos de Asignaci√≥n</h3>
                    <p className="text-xs text-slate-500">Recibe alertas cuando se asignen socios.</p>
                </div>
            </div>

            <div className="flex items-center gap-3">
                <button
                    onClick={handleTestNotification}
                    className="p-1.5 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors"
                    title="Probar notificaci√≥n"
                >
                    <Bell className="h-4 w-4" />
                </button>

                <button
                    onClick={handleToggle}
                    disabled={saving}
                    className={`relative inline-flex h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${enabled ? 'bg-blue-500' : 'bg-slate-300'}`}
                >
                    <span className={`pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${enabled ? 'translate-x-5' : 'translate-x-0'}`}>
                        {saving && <Loader2 className="h-4 w-4 m-1 animate-spin text-blue-500" />}
                    </span>
                </button>
            </div>
        </div>
    );
};

// Componente para Configuraci√≥n del Spotlight de Candidatos (Compacto)
const ConfiguracionSpotlight = () => {
    const [enabled, setEnabled] = useState(true);
    const [saving, setSaving] = useState(false);

    useEffect(() => {
        const preference = localStorage.getItem("spotlight_enabled");
        if (preference === "false") setEnabled(false);
    }, []);

    const handleToggle = async () => {
        const newValue = !enabled;
        setSaving(true);
        localStorage.setItem("spotlight_enabled", newValue ? "true" : "false");
        setEnabled(newValue);

        // Simular delay breve para feedback visual
        setTimeout(() => setSaving(false), 300);

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });
        Toast.fire({
            icon: newValue ? 'success' : 'info',
            title: newValue ? 'Spotlight Activado' : 'Spotlight Desactivado'
        });
    };

    return (
        <div className="flex items-center justify-between p-4 rounded-xl border border-slate-100 bg-white hover:border-slate-200 transition-colors">
            <div className="flex items-center gap-4">
                <div className={`p-2.5 rounded-lg transition-colors ${enabled ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-400'}`}>
                    <Star className="h-5 w-5" />
                </div>
                <div>
                    <h3 className="text-sm font-bold text-slate-800">Spotlight de Candidatos</h3>
                    <p className="text-xs text-slate-500">Muestra popups autom√°ticos de candidatos.</p>
                </div>
            </div>

            <button
                onClick={handleToggle}
                disabled={saving}
                className={`relative inline-flex h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 ${enabled ? 'bg-amber-500' : 'bg-slate-300'}`}
            >
                <span className={`pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${enabled ? 'translate-x-5' : 'translate-x-0'}`}>
                    {saving && <Loader2 className="h-4 w-4 m-1 animate-spin text-amber-500" />}
                </span>
            </button>
        </div>
    );
};

// Componente de Gesti√≥n Listas (Compacto)
const ConfiguracionGestionListas = () => {
    const router = useRouter();
    return (
        <div className="flex items-center justify-between p-4 rounded-xl border border-slate-100 bg-white hover:border-slate-200 transition-colors">
            <div className="flex items-center gap-4">
                <div className="p-2.5 rounded-lg bg-teal-100 text-teal-600">
                    <ClipboardList className="h-5 w-5" />
                </div>
                <div>
                    <h3 className="text-sm font-bold text-slate-800">Operativa de Listas</h3>
                    <p className="text-xs text-slate-500">Gesti√≥n global de candidatos y listas.</p>
                </div>
            </div>

            <button
                onClick={() => router.push("/gestion-listas")}
                className="px-4 py-2 bg-teal-500 text-white text-xs font-bold rounded-lg hover:bg-teal-600 transition-colors"
            >
                Acceder
            </button>
        </div>
    );
};

// Componente para Restricci√≥n Solo Voz y Voto
const ConfiguracionSoloVozVoto = () => {
    const { updateConfig } = useConfig();
    const [enabled, setEnabled] = useState(false);
    const [saving, setSaving] = useState(false);
    const [loaded, setLoaded] = useState(false);

    // Cargar estado actual de la configuraci√≥n
    useEffect(() => {
        const fetchConfig = async () => {
            try {
                const token = localStorage.getItem("token");
                const res = await axios.get("/api/configuracion", {
                    headers: { Authorization: `Bearer ${token}` }
                });
                // Manejar diferentes formatos de respuesta
                const data = res.data;
                if (Array.isArray(data)) {
                    const config = data.find((c: any) => c.clave === "SOLO_VOZ_VOTO_ACTIVO");
                    if (config) {
                        setEnabled(config.valor === "true");
                    }
                } else if (data && typeof data === 'object') {
                    if (data.SOLO_VOZ_VOTO_ACTIVO !== undefined) {
                        setEnabled(data.SOLO_VOZ_VOTO_ACTIVO === "true");
                    }
                }
            } catch (error) {
                console.error("Error cargando config de solo voz y voto:", error);
            } finally {
                setLoaded(true);
            }
        };
        fetchConfig();
    }, []);

    const handleToggle = async () => {
        const newValue = !enabled;
        setSaving(true);
        try {
            await updateConfig("SOLO_VOZ_VOTO_ACTIVO", newValue ? "true" : "false");
            setEnabled(newValue);

            Swal.fire({
                title: newValue ? 'üó≥Ô∏è Restricci√≥n ACTIVADA' : '‚úÖ Restricci√≥n DESACTIVADA',
                html: newValue
                    ? '<p class="text-slate-600">Ahora <strong>solo se podr√°n asignar socios que tengan Voz y Voto</strong>.<br/>Los usuarios ver√°n un mensaje profesional si intentan agregar un socio que solo tiene voz.</p>'
                    : '<p class="text-slate-600">Se permite asignar <strong>cualquier socio</strong> independientemente de su condici√≥n de voto.</p>',
                icon: newValue ? 'warning' : 'success',
                confirmButtonText: 'Entendido',
                confirmButtonColor: newValue ? '#f59e0b' : '#10b981',
                padding: '2em',
                customClass: {
                    popup: 'rounded-[2rem] shadow-2xl'
                }
            });
        } catch (error) {
            Swal.fire({
                title: 'Error',
                text: 'No se pudo actualizar la configuraci√≥n',
                icon: 'error',
                confirmButtonColor: '#ef4444'
            });
        } finally {
            setSaving(false);
        }
    };

    if (!loaded) return null;

    // Layout Compacto Voz y Voto
    return (
        <div className="flex items-center justify-between p-4 rounded-xl border border-slate-100 bg-white hover:border-slate-200 transition-colors">
            <div className="flex items-center gap-4">
                <div className={`p-2.5 rounded-lg transition-colors ${enabled ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-400'}`}>
                    <Check className="h-5 w-5" />
                </div>
                <div>
                    <h3 className="text-sm font-bold text-slate-800">Restricci√≥n de Asignaciones</h3>
                    <p className="text-xs text-slate-500">Solo permite asignar socios con Voz y Voto.</p>
                </div>
            </div>

            <button
                onClick={handleToggle}
                disabled={saving}
                className={`relative inline-flex h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 ${enabled ? 'bg-emerald-500' : 'bg-slate-300'}`}
            >
                <span className={`pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${enabled ? 'translate-x-5' : 'translate-x-0'}`}>
                    {saving && <Loader2 className="h-4 w-4 m-1 animate-spin text-emerald-500" />}
                </span>
            </button>
        </div>
    );
};

// Componente para Fecha L√≠mite de Asignaci√≥n - REDISE√ëO PREMIUM
const ConfiguracionFechaLimite = () => {
    const { updateConfig } = useConfig();
    const [activa, setActiva] = useState(false);
    const [fechaLimite, setFechaLimite] = useState("");
    const [pruebaActiva, setPruebaActiva] = useState(false);
    const [saving, setSaving] = useState(false);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchConfig = async () => {
            try {
                const token = localStorage.getItem("token");
                const res = await axios.get("/api/configuracion/fecha-limite", {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = res.data;
                setActiva(data.activa);
                setFechaLimite(data.fechaLimite || "");
                setPruebaActiva(data.pruebaActiva);
            } catch (error) {
                console.error("Error cargando config de fecha l√≠mite:", error);
            } finally {
                setLoading(false);
            }
        };
        fetchConfig();
    }, []);

    const handleSave = async () => {
        setSaving(true);
        try {
            await updateConfig("FECHA_LIMITE_ACTIVA", activa ? "true" : "false");
            await updateConfig("FECHA_LIMITE_ASIGNACION", fechaLimite);

            Swal.fire({
                title: '<span class="text-2xl font-black italic">¬°TIEMPO CONFIGURADO!</span>',
                html: `<p class="text-slate-600">${activa
                    ? `Las listas se cerrar√°n autom√°ticamente el <b>${new Date(fechaLimite).toLocaleString()}</b>`
                    : 'Se ha desactivado la restricci√≥n de tiempo.'}</p>`,
                icon: 'success',
                confirmButtonColor: '#f59e0b',
                customClass: {
                    popup: 'rounded-[2rem] border-4 border-orange-100 shadow-2xl'
                }
            });
        } catch (error) {
            Swal.fire({ title: 'Error', text: 'No se pudo guardar la configuraci√≥n', icon: 'error' });
        } finally {
            setSaving(false);
        }
    };

    const handleTogglePrueba = async () => {
        const token = localStorage.getItem("token");
        const action = pruebaActiva ? 'desactivar-prueba' : 'activar-prueba';

        try {
            const res = await axios.post(`/api/configuracion/fecha-limite/${action}`, {}, {
                headers: { Authorization: `Bearer ${token}` }
            });

            if (res.data.success) {
                setPruebaActiva(!pruebaActiva);
                Swal.fire({
                    title: !pruebaActiva ? 'üß™ MODO PRUEBA ACTIVO' : '‚úÖ SISTEMA RESTABLECIDO',
                    text: res.data.message,
                    icon: !pruebaActiva ? 'warning' : 'success',
                    confirmButtonColor: !pruebaActiva ? '#f59e0b' : '#10b981',
                    customClass: {
                        popup: 'rounded-[2rem] shadow-2xl'
                    }
                });
            }
        } catch (error) {
            Swal.fire({ title: 'Error', text: 'Error al cambiar estado de prueba', icon: 'error' });
        }
    };

    if (loading) return null;

    return (
        <div className="relative group">
            {/* T√≠tulo decorativo */}
            <h2 className="text-2xl font-black text-slate-800 flex items-center gap-3 italic uppercase mt-10 mb-6 group-hover:translate-x-1 transition-transform">
                <div className="p-2 bg-orange-100 rounded-lg group-hover:bg-orange-500 group-hover:text-white transition-all shadow-sm">
                    <Clock className="h-6 w-6" />
                </div>
                Cronograma de Asignaci√≥n
            </h2>

            <div className="relative overflow-hidden bg-white/40 backdrop-blur-xl rounded-[2.5rem] border border-slate-200/50 shadow-2xl shadow-slate-200/50 p-1 md:p-2">
                <div className={`rounded-[2rem] p-6 md:p-10 transition-all duration-700 ${activa ? 'bg-gradient-to-br from-orange-50/80 via-white to-amber-50/50' : 'bg-slate-50/50'}`}>

                    {/* Header: Switch */}
                    <div className="flex flex-col md:flex-row items-center justify-between gap-8 mb-10">
                        <div className="flex-1 space-y-2">
                            <div className="flex items-center gap-3">
                                <div className={`w-3 h-3 rounded-full animate-pulse ${activa ? 'bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.5)]' : 'bg-slate-300'}`} />
                                <h3 className="text-xl font-black text-slate-800 uppercase italic tracking-tight">Cierre Automatizado</h3>
                            </div>
                            <p className="text-slate-500 font-medium max-w-lg leading-relaxed">
                                Al activar esta opci√≥n, el sistema bloquear√° nuevas asignaciones una vez alcanzada la fecha l√≠mite. Los socios recibir√°n un aviso premium de impacto al entrar.
                            </p>
                        </div>

                        <button
                            onClick={() => setActiva(!activa)}
                            className={`relative inline-flex h-12 w-24 flex-shrink-0 cursor-pointer rounded-full border-4 border-white shadow-inner transition-all duration-500 ease-in-out focus:outline-none ${activa ? 'bg-orange-500' : 'bg-slate-300'}`}
                        >
                            <div className={`pointer-events-none absolute inset-y-0 left-0 w-10 transform scale-90 rounded-full bg-white shadow-lg transition-all duration-500 ease-in-out ${activa ? 'translate-x-12' : 'translate-x-0'}`}>
                                <div className="w-full h-full flex items-center justify-center">
                                    <div className={`w-1.5 h-1.5 rounded-full ${activa ? 'bg-orange-500' : 'bg-slate-300'}`} />
                                </div>
                            </div>
                        </button>
                    </div>

                    <AnimatePresence>
                        {activa && (
                            <motion.div
                                initial={{ opacity: 0, height: 0, y: 20 }}
                                animate={{ opacity: 1, height: 'auto', y: 0 }}
                                exit={{ opacity: 0, height: 0, y: 20 }}
                                className="space-y-8"
                            >
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="group/input relative">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-3 block pl-2">Fecha y Hora de Cierre</label>
                                        <div className="relative">
                                            <Calendar className="absolute left-6 top-1/2 -translate-y-1/2 h-5 w-5 text-orange-400 group-hover/input:scale-110 transition-transform" />
                                            <input
                                                type="datetime-local"
                                                value={fechaLimite}
                                                onChange={(e) => setFechaLimite(e.target.value)}
                                                className="w-full bg-white/70 backdrop-blur rounded-2xl border-2 border-slate-100 pl-16 pr-6 py-5 text-lg font-black text-slate-800 focus:border-orange-400 focus:bg-white outline-none transition-all shadow-sm hover:border-orange-200"
                                            />
                                        </div>
                                    </div>

                                    <div className="flex items-end">
                                        <button
                                            onClick={handleSave}
                                            disabled={saving}
                                            className="group/btn relative w-full overflow-hidden rounded-2xl bg-slate-900 px-8 py-5 transition-all active:scale-95 shadow-xl hover:shadow-orange-200"
                                        >
                                            <div className="absolute inset-0 bg-gradient-to-r from-orange-400 to-amber-500 opacity-0 group-hover/btn:opacity-100 transition-opacity duration-500" />
                                            <span className="relative flex items-center justify-center gap-3 text-sm font-black uppercase tracking-widest text-white">
                                                {saving ? "Procesando..." : (
                                                    <><Plus className="h-5 w-5" /> Confirmar Programaci√≥n</>
                                                )}
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>

                    {/* Footer: Modo Prueba */}
                    <div className={`mt-10 pt-8 border-t border-slate-200/60 flex flex-col md:flex-row items-center justify-between gap-6 ${!activa ? 'opacity-50 grayscale' : ''}`}>
                        <div className="flex items-center gap-4">
                            <div className={`p-3 rounded-2xl ${pruebaActiva ? 'bg-red-100 animate-pulse' : 'bg-slate-100'}`}>
                                <Hammer className={`h-6 w-6 ${pruebaActiva ? 'text-red-500' : 'text-slate-400'}`} />
                            </div>
                            <div>
                                <h4 className="font-black text-slate-800 text-sm uppercase italic">Simulador de Cierre</h4>
                                <p className="text-xs text-slate-500 font-medium">Fuerza el bloqueo inmediato para verificar la UX del socio.</p>
                            </div>
                        </div>

                        <button
                            onClick={handleTogglePrueba}
                            disabled={!activa}
                            className={`px-8 py-4 rounded-xl font-black text-xs uppercase tracking-[0.2em] transition-all shadow-xl active:scale-95 ${pruebaActiva
                                ? 'bg-red-500 text-white shadow-red-200 hover:bg-red-600'
                                : 'bg-white border-2 border-slate-200 text-slate-700 hover:border-orange-500 hover:text-orange-500'
                                }`}
                        >
                            {pruebaActiva ? "Finalizar Prueba" : "Probar Cierre Ahora"}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};

// Componente para Modo de Prueba (Compacto)
const ConfiguracionModoPrueba = () => {
    const { isTestMode, testModeInfo, activateTestMode, deactivateTestMode } = useConfig();
    const [saving, setSaving] = useState(false);

    const handleActivate = async () => {
        const result = await Swal.fire({
            title: '¬øActivar Modo de Prueba?',
            text: 'Se crear√° una copia de seguridad. Los cambios que hagas NO ser√°n permanentes.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#8b5cf6',
            confirmButtonText: 'S√≠, Activar',
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        setSaving(true);
        const response = await activateTestMode();
        setSaving(false);

        if (response.success) {
            Swal.fire({ title: 'Modo Prueba Activado', icon: 'success' });
        } else {
            Swal.fire({ title: 'Error', text: response.error, icon: 'error' });
        }
    };

    const handleDeactivate = async () => {
        const result = await Swal.fire({
            title: '¬øRestaurar Sistema?',
            text: 'Se perder√°n todos los cambios hechos durante la prueba.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'S√≠, Restaurar',
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        setSaving(true);
        const response = await deactivateTestMode();
        setSaving(false);

        if (response.success) {
            Swal.fire({ title: 'Sistema Restaurado', icon: 'success' });
        } else {
            Swal.fire({ title: 'Error', text: response.error, icon: 'error' });
        }
    };

    return (
        <div className="flex items-center justify-between p-4 rounded-xl border border-slate-100 bg-white hover:border-slate-200 transition-colors">
            <div className="flex items-center gap-4">
                <div className={`p-2.5 rounded-lg transition-colors ${isTestMode ? 'bg-violet-500 text-white animate-pulse' : 'bg-slate-100 text-slate-400'}`}>
                    <Database className="h-5 w-5" />
                </div>
                <div>
                    <h3 className="text-sm font-bold text-slate-800">Modo de Prueba /Sandbox</h3>
                    <p className="text-xs text-slate-500">
                        {isTestMode ? "Activo: Los cambios no son permanentes." : "Prueba el sistema sin riesgos."}
                    </p>
                </div>
            </div>

            <button
                onClick={isTestMode ? handleDeactivate : handleActivate}
                disabled={saving}
                className={`relative inline-flex h-7 w-12 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 ${isTestMode ? 'bg-violet-500' : 'bg-slate-300'}`}
            >
                <span className={`pointer-events-none inline-block h-6 w-6 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out ${isTestMode ? 'translate-x-5' : 'translate-x-0'}`}>
                    {saving && <Loader2 className="h-4 w-4 m-1 animate-spin text-violet-500" />}
                </span>
            </button>
        </div>
    );
};

// Subcomponente para Opciones de Reset
const ResetOptionsPanel = ({ isAdminMode, accessCode, setAccessCode, checkAccess, setIsAdminMode, loading, handleReset }: any) => {
    const [options, setOptions] = useState({
        socios: true,
        asignaciones: true,
        listas: true,
        usuarios: true,
        asistencias: true,
        importaciones: true
    });

    // Validar dependencias visualmente
    useEffect(() => {
        const newOptions = { ...options };
        // Si borras listas, borras asignaciones
        if (newOptions.listas && !newOptions.asignaciones) setOptions(prev => ({ ...prev, asignaciones: true }));
    }, [options.listas]);

    const toggleOption = (key: keyof typeof options) => {
        setOptions(prev => ({ ...prev, [key]: !prev[key] }));
    };

    const onResetClick = () => {
        handleReset(options);
    };

    return (
        <div className="rounded-2xl border-2 border-red-100 bg-gradient-to-br from-red-50/50 to-orange-50/30 p-8 space-y-6 relative overflow-hidden">
            <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-red-100/50 to-transparent rounded-full -translate-y-1/2 translate-x-1/2" />
            <div className="flex items-center gap-3 text-red-700 relative">
                <div className="p-2 bg-red-100 rounded-xl">
                    <ShieldAlert className="h-6 w-6" />
                </div>
                <h2 className="text-xl font-black uppercase tracking-tight">Zona de Peligro /Reset</h2>
            </div>

            <div className="bg-white rounded-2xl p-6 border border-red-100 shadow-lg relative">
                {!isAdminMode ? (
                    <div className="space-y-6">
                        <div className="flex items-start gap-4">
                            <div className="bg-amber-100 p-3 rounded-xl">
                                <Key className="h-6 w-6 text-amber-600" />
                            </div>
                            <div className="flex-1">
                                <h3 className="font-bold text-slate-800 text-lg">Acceso Protegido</h3>
                                <p className="text-sm text-slate-500 mt-1">
                                    Ingresa el c√≥digo maestro de administrador para desbloquear las opciones de limpieza.
                                </p>
                            </div>
                        </div>
                        <div className="bg-slate-50 rounded-xl p-4 md:p-5 flex flex-col sm:flex-row gap-3">
                            <input
                                type="password"
                                value={accessCode}
                                onChange={(e) => setAccessCode(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && checkAccess()}
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                className="w-full sm:flex-1 rounded-xl border-2 border-slate-200 px-4 py-3 text-center text-lg font-mono tracking-[0.3em] md:tracking-[0.5em] outline-none focus:border-amber-500 transition-all"
                                maxLength={6}
                            />
                            <button
                                onClick={checkAccess}
                                className="w-full sm:w-auto px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-xl transition-all"
                            >
                                Desbloquear
                            </button>
                        </div>
                    </div>
                ) : (
                    <div className="space-y-6">
                        <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-3 flex justify-between items-center">
                            <span className="text-sm font-bold text-teal-500 flex items-center gap-2">
                                <Check className="h-4 w-4" /> Modo Administrador
                            </span>
                            <button onClick={() => setIsAdminMode(false)} className="text-xs text-emerald-500 font-bold hover:underline">Bloquear</button>
                        </div>

                        <div className="space-y-4">
                            <p className="text-sm font-bold text-slate-700 uppercase tracking-wide">Selecciona qu√© datos eliminar:</p>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                {[
                                    { key: "socios", label: "Padr√≥n de Socios", desc: "Borra todos los socios (CUIDADO)" },
                                    { key: "asignaciones", label: "Asignaciones", desc: "Borra las distribuciones de socios en listas" },
                                    { key: "listas", label: "Listas Creadas", desc: "Borra las listas vac√≠as o llenas de los operadores" },
                                    { key: "usuarios", label: "Cuentas de Operadores", desc: "Borra los usuarios (Login)" },
                                    { key: "asistencias", label: "Control de Asistencia", desc: "Borra registros de check-in" },
                                    { key: "importaciones", label: "Historial de Importaci√≥n", desc: "Limpia el log de importaciones" },
                                ].map((opt) => (
                                    <label key={opt.key} className={`flex items-start gap-3 p-3 rounded-xl border-2 transition-all cursor-pointer ${(options as any)[opt.key] ? 'border-red-200 bg-red-50/50' : 'border-slate-100 hover:border-slate-200'
                                        }`}>
                                        <input
                                            type="checkbox"
                                            checked={(options as any)[opt.key]}
                                            onChange={() => toggleOption(opt.key as any)}
                                            className="mt-1 w-4 h-4 accent-red-600"
                                        />
                                        <div>
                                            <span className="block font-bold text-slate-800 text-sm">{opt.label}</span>
                                            <span className="block text-[10px] text-slate-500 leading-tight">{opt.desc}</span>
                                        </div>
                                    </label>
                                ))}
                            </div>
                        </div>

                        <button
                            onClick={onResetClick}
                            disabled={loading}
                            className="w-full py-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-black rounded-xl shadow-lg shadow-red-500/20 transition-all flex items-center justify-center gap-2"
                        >
                            {loading ? <Loader2 className="animate-spin" /> : <Trash2 />}
                            EJECUTAR LIMPIEZA SELECCIONADA
                        </button>
                    </div>
                )}
            </div>
        </div>
    );
}

export default function ConfiguracionPage() {
    const [user, setUser] = useState<any>(null);
    const [confirmText, setConfirmText] = useState("");
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState<{ type: "success" | "error", text: string } | null>(null);

    // Tour hook
    const { resetAllTours, startTour, hasSeenTour } = useTour();



    // Perfil /Password States
    const [currentPassword, setCurrentPassword] = useState("");
    const [newPassword, setNewPassword] = useState("");
    const [confirmPassword, setConfirmPassword] = useState("");
    const [savingPass, setSavingPass] = useState(false);

    // Hidden Admin Module State (Solo para ADMIN)
    const [accessCode, setAccessCode] = useState("");
    const [isAdminMode, setIsAdminMode] = useState(false);
    const [searchQuery, setSearchQuery] = useState("");
    const [foundSocios, setFoundSocios] = useState<any[]>([]);
    const [isSearching, setIsSearching] = useState(false);
    const [updatingSocioId, setUpdatingSocioId] = useState<number | null>(null);

    // Personal Data States
    const [email, setEmail] = useState("");
    const [telefono, setTelefono] = useState("");
    const [fotoPerfil, setFotoPerfil] = useState("");
    const [savingPersonal, setSavingPersonal] = useState(false);

    // Logout all sessions
    const [closingSessions, setClosingSessions] = useState(false);
    const router = useRouter();

    // Handler para reiniciar gu√≠a
    const handleResetTour = () => {
        resetAllTours();
        Swal.fire({
            title: '¬°Gu√≠a Reiniciada!',
            text: 'La pr√≥xima vez que entres al Dashboard ver√°s el tutorial de nuevo.',
            icon: 'success',
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#10b981',
            padding: '2em',
            customClass: {
                popup: 'rounded-[2rem] shadow-2xl'
            }
        });
    };

    useEffect(() => {
        const userData = localStorage.getItem("user");
        if (userData) {
            const u = JSON.parse(userData);
            setUser(u);
            setEmail(u.email || "");
            setTelefono(u.telefono || "");
            setFotoPerfil(u.fotoPerfil || "");
        }
    }, []);

    const handleFotoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            if (file.size > 5000000) { // 5MB limit
                setMessage({ type: 'error', text: 'La imagen es demasiado grande (M√°x 5MB)' });
                return;
            }
            const reader = new FileReader();
            reader.onloadend = () => {
                setFotoPerfil(reader.result as string);
            };
            reader.readAsDataURL(file);
        }
    };

    const handleSavePersonal = async (e: React.FormEvent) => {
        e.preventDefault();
        setMessage(null);

        // Validaci√≥n @gmail.com
        if (email && !email.toLowerCase().endsWith("@gmail.com")) {
            setMessage({ type: 'error', text: 'El correo electr√≥nico debe ser una cuenta @gmail.com' });
            return;
        }

        setSavingPersonal(true);
        try {
            const token = localStorage.getItem("token");
            await axios.put(`/api/usuarios/${user.id}`, {
                email,
                telefono,
                fotoPerfil
            }, {
                headers: { Authorization: `Bearer ${token}` }
            });

            // Actualizar Local Storage
            const updatedUser = { ...user, email, telefono, fotoPerfil };
            localStorage.setItem("user", JSON.stringify(updatedUser));
            setUser(updatedUser);

            setMessage({ type: 'success', text: 'Datos personales actualizados correctamente' });
        } catch (error: any) {
            setMessage({
                type: 'error',
                text: error.response?.data?.error || 'Error al actualizar datos'
            });
        } finally {
            setSavingPersonal(false);
        }
    };

    const handleChangePassword = async (e: React.FormEvent) => {
        e.preventDefault();
        if (newPassword !== confirmPassword) {
            setMessage({ type: 'error', text: 'Las contrase√±as no coinciden' });
            return;
        }

        setSavingPass(true);
        setMessage(null);

        try {
            const token = localStorage.getItem("token");
            await axios.post("/api/usuarios/cambiar-password-actual", {
                currentPassword,
                newPassword
            }, {
                headers: { Authorization: `Bearer ${token}` }
            });

            setMessage({ type: 'success', text: 'Contrase√±a actualizada correctamente' });
            setCurrentPassword("");
            setNewPassword("");
            setConfirmPassword("");
        } catch (error: any) {
            setMessage({
                type: 'error',
                text: error.response?.data?.error || 'Error al cambiar la contrase√±a'
            });
        } finally {
            setSavingPass(false);
        }
    };

    const handleLogoutAllSessions = async () => {
        const result = await Swal.fire({
            title: '¬øCerrar Todas las Sesiones?',
            text: 'Esto invalidar√° todos los tokens activos. Tendr√°s que volver a iniciar sesi√≥n.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'S√≠, Cerrar Todas',
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        setClosingSessions(true);
        try {
            const token = localStorage.getItem("token");
            await axios.post("/api/auth/logout-all-sessions", {}, {
                headers: { Authorization: `Bearer ${token}` }
            });

            Swal.fire({
                title: '¬°Sesiones Cerradas!',
                text: 'Todas tus sesiones han sido invalidadas. Ser√°s redirigido al login.',
                icon: 'success',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#10b981'
            }).then(() => {
                localStorage.removeItem("token");
                localStorage.removeItem("user");
                router.push("/login");
            });
        } catch (error: any) {
            Swal.fire({
                title: 'Error',
                text: error.response?.data?.error || 'No se pudieron cerrar las sesiones',
                icon: 'error',
                confirmButtonColor: '#ef4444'
            });
        } finally {
            setClosingSessions(false);
        }
    };

    const handleResetData = async (type: 'padron' | 'factory') => {
        if (type === 'padron' && confirmText !== "REINICIAR_TODO_EL_PADRON") {
            setMessage({ type: "error", text: "Texto de confirmaci√≥n incorrecto." });
            return;
        }

        setLoading(true);
        setMessage(null);
        try {
            const token = localStorage.getItem("token");
            if (!token) {
                setMessage({ type: "error", text: "No hay sesi√≥n activa. Por favor, cierra sesi√≥n e inicia de nuevo." });
                return;
            }
            const response = await axios.post(`/api/socios/reset-${type}`, {}, {
                headers: { Authorization: `Bearer ${token}` }
            });
            console.log("Reset response:", response.data);
            setMessage({ type: "success", text: `¬°Sistema reiniciado! Se eliminaron ${response.data.eliminados?.socios || 0} socios, ${response.data.eliminados?.asistencias || 0} asistencias, ${response.data.eliminados?.asignaciones || 0} asignaciones.` });
            setConfirmText("");
            setIsAdminMode(false);
        } catch (error: any) {
            console.error("Error en reset:", error);
            setMessage({ type: "error", text: "Error al reiniciar: " + (error.message || "Error desconocido") });
        } finally {
            setLoading(false);
        }
    };

    // Funci√≥n simplificada de reset-usando endpoint principal
    const handleSimpleReset = async (options: any = {}) => {
        setLoading(true);
        setMessage(null);
        try {
            const token = localStorage.getItem("token");
            if (!token) throw new Error("No hay sesi√≥n activa. Recarga la p√°gina.");

            // Usar el endpoint oficial que borra todo con opciones
            const response = await axios.post("/api/socios/reset-padron", options, {
                headers: { Authorization: `Bearer ${token}` }
            });

            console.log("Reset response:", response.data);
            setMessage({
                type: "success",
                text: `¬°Limpieza completada! ${response.data.message}`
            });
            setIsAdminMode(false);
        } catch (error: any) {
            console.error("Error en reset:", error);
            setMessage({ type: "error", text: "Error: " + (error.response?.data?.error || error.message) });
        } finally {
            setLoading(false);
        }
    };

    const checkAccess = () => {
        if (accessCode === "226118") {
            setIsAdminMode(true);
            setAccessCode("");
            setMessage({ type: "success", text: "Modo Administrador Maestro activado." });
        } else {
            setMessage({ type: "error", text: "C√≥digo incorrecto." });
        }
    };

    const handleSearchSocio = useCallback(async (query: string) => {
        if (query.length < 2) return;
        setIsSearching(true);
        try {
            const token = localStorage.getItem("token");
            const response = await axios.get(`/api/socios/buscar?term=${query}`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            setFoundSocios(response.data);
        } catch (error) {
            console.error("Error buscando socio:", error);
        } finally {
            setIsSearching(false);
        }
    }, []);

    useEffect(() => {
        const timer = setTimeout(() => {
            if (searchQuery) handleSearchSocio(searchQuery);
        }, 500);
        return () => clearTimeout(timer);
    }, [searchQuery, handleSearchSocio]);

    const toggleStatus = async (socioId: number, field: string, currentValue: boolean) => {
        setUpdatingSocioId(socioId);
        try {
            const token = localStorage.getItem("token");
            await axios.patch(`/api/socios/${socioId}/estado`,
                { [field]: !currentValue },
                { headers: { Authorization: `Bearer ${token}` } }
            );
            // Actualizar localmente
            setFoundSocios(prev => prev.map(s =>
                s.id === socioId ? { ...s, [field]: !currentValue } : s
            ));
        } catch (error) {
            console.error("Error actualizando estado:", error);
            alert("Error al actualizar el estado");
        } finally {
            setUpdatingSocioId(null);
        }
    };

    const isSocio = user?.rol === "USUARIO_SOCIO";
    const isSuperAdmin = user?.rol === "SUPER_ADMIN";

    return (
        <div className="max-w-4xl space-y-8 pb-20 mt-2 md:mt-0">
            <div data-tour="config-header">
                <h1 className="text-2xl font-black text-slate-800 italic uppercase tracking-tight">Mi Perfil y Configuraci√≥n</h1>
                <p className="text-slate-500">Gestiona tu cuenta y par√°metros del sistema</p>
            </div>

            {/* SECCI√ìN PERFIL (VISIBLE PARA TODOS) */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="md:col-span-1 bg-white rounded-2xl p-6 border border-slate-100 shadow-sm text-center flex flex-col items-center justify-center">
                    <div className="relative group">
                        <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mb-4 border-4 border-white shadow-xl overflow-hidden">
                            {fotoPerfil || user?.fotoPerfil ? (
                                <img src={fotoPerfil || user?.fotoPerfil} alt="Perfil" className="w-full h-full object-cover" />
                            ) : (
                                <UserCircle2 className="h-12 w-12 text-emerald-500" />
                            )}
                        </div>
                        <label className="absolute bottom-4 right-0 p-1.5 bg-slate-800 rounded-full text-white cursor-pointer hover:bg-black transition-colors shadow-lg">
                            <Camera className="h-3 w-3" />
                            <input type="file" className="hidden" accept="image/*" onChange={handleFotoUpload} />
                        </label>
                    </div>
                    <h2 className="font-bold text-slate-800 line-clamp-1">{user?.nombreCompleto}</h2>
                    <p className="text-xs text-slate-400 font-medium mb-4">@{user?.username}</p>
                    <div className="inline-flex items-center gap-2 px-3 py-1 bg-teal-50 text-teal-500 rounded-full text-[10px] font-black uppercase tracking-wider">
                        <UserCircle2 className="h-3 w-3" />
                        ROL: {user?.rol}
                    </div>
                </div>

                <div className="md:col-span-2 bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2" data-tour="config-profile">
                        <Key className="h-4 w-4 text-emerald-500" />
                        <h2 className="text-sm font-bold text-slate-700 uppercase">Datos Personales & Seguridad</h2>
                    </div>

                    <form onSubmit={handleSavePersonal} className="p-5 space-y-4 border-b border-slate-100">
                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Informaci√≥n B√°sica</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div className="space-y-1">
                                <label className="text-[10px] font-bold text-slate-500 uppercase">Correo Gmail (Para Notificaciones)</label>
                                <div className="relative">
                                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                                    <input
                                        type="email"
                                        placeholder="usuario@gmail.com"
                                        className="w-full pl-9 pr-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 ring-emerald-500 outline-none"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        pattern=".*@gmail\.com"
                                        title="Debe ser una direcci√≥n @gmail.com"
                                    />
                                </div>
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] font-bold text-slate-500 uppercase">Tel√©fono /WhatsApp</label>
                                <div className="relative">
                                    <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                                    <input
                                        type="tel"
                                        placeholder="+595 981 ..."
                                        className="w-full pl-9 pr-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 ring-emerald-500 outline-none"
                                        value={telefono}
                                        onChange={(e) => setTelefono(e.target.value)}
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end">
                            <button
                                type="submit"
                                disabled={savingPersonal}
                                className="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors disabled:opacity-50 flex items-center gap-2"
                            >
                                {savingPersonal ? <Loader2 className="h-3 w-3 animate-spin" /> : <Save className="h-3 w-3" />}
                                Guardar Datos
                            </button>
                        </div>
                    </form>

                    <form onSubmit={handleChangePassword} className="p-5 space-y-4">
                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-wider mb-2">Seguridad de la Cuenta</h3>
                        {message && message.text.includes("Contrase√±a") && (
                            <div className={`p-3 rounded-lg text-xs font-bold flex items-center gap-2 ${message.type === 'success' ? 'bg-emerald-50 text-teal-500' : 'bg-red-50 text-red-700'}`}>
                                {message.type === 'success' ? <Check className="h-4 w-4" /> : <ShieldAlert className="h-4 w-4" />}
                                {message.text}
                            </div>
                        )}
                        <div className="grid grid-cols-1 gap-4">
                            <input
                                type="password"
                                placeholder="Contrase√±a Actual"
                                className="px-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 ring-emerald-500 outline-none"
                                value={currentPassword}
                                onChange={(e) => setCurrentPassword(e.target.value)}
                                required
                            />
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input
                                    type="password"
                                    placeholder="Nueva Contrase√±a"
                                    className="px-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 ring-emerald-500 outline-none"
                                    value={newPassword}
                                    onChange={(e) => setNewPassword(e.target.value)}
                                    required
                                />
                                <input
                                    type="password"
                                    placeholder="Confirmar Nueva"
                                    className="px-4 py-2.5 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 ring-emerald-500 outline-none"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    required
                                />
                            </div>
                        </div>
                        <button
                            type="submit"
                            disabled={savingPass}
                            className="bg-emerald-500 text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-teal-500 transition-colors shadow-lg shadow-emerald-500/20 disabled:opacity-50"
                        >
                            {savingPass ? "Guardando..." : "Actualizar Contrase√±a"}
                        </button>
                    </form>
                </div>
            </div>

            {/* Secci√≥n Gu√≠a de Principiante */}
            <div className="rounded-2xl bg-white p-6 border border-slate-100 shadow-sm">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl shadow-lg shadow-indigo-200">
                            <HelpCircle className="h-6 w-6 text-white" />
                        </div>
                        <div>
                            <h2 className="text-lg font-bold text-slate-800">Gu√≠a de Principiante</h2>
                            <p className="text-sm text-slate-500">
                                ¬øNecesitas ver el tutorial de nuevo? Rein√≠cialo aqu√≠.
                            </p>
                        </div>
                    </div>
                    <button
                        data-tour="config-guide"
                        onClick={handleResetTour}
                        className="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-bold text-sm hover:from-indigo-600 hover:to-purple-600 transition-all shadow-lg shadow-indigo-200"
                    >
                        <RotateCcw className="h-4 w-4" />
                        Reiniciar Gu√≠a
                    </button>
                </div>
            </div>

            {/* Secci√≥n Cerrar Todas las Sesiones */}
            <div className="rounded-2xl bg-gradient-to-br from-red-50 to-orange-50 p-6 border border-red-100 shadow-sm">
                <div className="flex items-center justify-between flex-wrap gap-4">
                    <div className="flex items-center gap-4">
                        <div className="p-3 bg-gradient-to-br from-red-500 to-orange-500 rounded-xl shadow-lg shadow-red-200">
                            <ShieldAlert className="h-6 w-6 text-white" />
                        </div>
                        <div>
                            <h2 className="text-lg font-bold text-slate-800">Seguridad de la Cuenta</h2>
                            <p className="text-sm text-slate-500">
                                Si sospechas que alguien accedi√≥ a tu cuenta, cierra todas las sesiones.
                            </p>
                        </div>
                    </div>
                    <button
                        onClick={handleLogoutAllSessions}
                        disabled={closingSessions}
                        className="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-xl font-bold text-sm hover:from-red-600 hover:to-orange-600 transition-all shadow-lg shadow-red-200 disabled:opacity-50"
                    >
                        {closingSessions ? <Loader2 className="h-4 w-4 animate-spin" /> : <ShieldAlert className="h-4 w-4" />}
                        Cerrar Todas las Sesiones
                    </button>
                </div>
            </div>

            {/* Configuraci√≥n de Spotlight - Disponible para todos */}
            <div className="rounded-2xl bg-white p-8 shadow-sm border border-slate-100 space-y-6">
                <ConfiguracionSpotlight />
            </div>

            {isSuperAdmin && (
                <>
                    <div className="h-px bg-slate-100 my-8"></div>


                    {/* Otras Configuraciones de Asamblea */}
                    <div className="rounded-2xl bg-white p-8 shadow-sm border border-slate-100 space-y-6">
                        <ConfiguracionEvento />
                        <ConfiguracionMantenimiento />
                        <ConfiguracionNotificaciones />
                        <ConfiguracionFechaLimite />
                        <ConfiguracionGestionListas />
                        <ConfiguracionSoloVozVoto />
                        <ConfiguracionModoPrueba />
                    </div>


                    <ResetOptionsPanel isAdminMode={isAdminMode} accessCode={accessCode} setAccessCode={setAccessCode} checkAccess={checkAccess} setIsAdminMode={setIsAdminMode} loading={loading} handleReset={handleSimpleReset} />


                    {/* Hidden Master Override Section */}
                    <div className="pt-20 pb-10 border-t border-slate-100 mt-12">
                        {!isAdminMode ? (
                            <div className="flex flex-col items-center gap-4 opacity-40 hover:opacity-100 transition-opacity grayscale hover:grayscale-0">
                                <div className="p-2 bg-slate-100 rounded-full">
                                    <Key className="h-4 w-4 text-slate-400" />
                                </div>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Master Override</p>
                                <div className="flex gap-2">
                                    <input
                                        type="password"
                                        value={accessCode}
                                        onChange={(e) => setAccessCode(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && checkAccess()}
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        className="w-40 rounded-xl border border-slate-200 bg-white px-4 py-2 text-center text-sm outline-none focus:border-slate-400 shadow-sm"
                                    />
                                </div>
                            </div>
                        ) : (
                            <div className="rounded-3xl bg-white p-8 shadow-2xl border-4 border-emerald-500/20 space-y-8 animate-in zoom-in-95 duration-300">
                                <div className="flex items-center justify-between border-b border-slate-100 pb-6">
                                    <div className="flex items-center gap-4">
                                        <div className="p-4 bg-emerald-500 rounded-2xl shadow-lg shadow-emerald-200">
                                            <ShieldAlert className="h-7 w-7 text-white" />
                                        </div>
                                        <div>
                                            <h2 className="text-2xl font-black text-slate-800 tracking-tight uppercase italic">Modificador Maestro</h2>
                                            <p className="text-emerald-500 text-xs font-black uppercase tracking-widest">Control Total de Estados</p>
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setIsAdminMode(false)}
                                        className="p-2 rounded-xl hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"
                                    >
                                        <X className="h-6 w-6" />
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    <div className="relative group">
                                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 h-6 w-6 text-slate-400 group-focus-within:text-emerald-500 transition-colors" />
                                        <input
                                            type="text"
                                            placeholder="Buscar socio para forzar cambio de estado..."
                                            className="w-full rounded-2xl bg-slate-50 border-2 border-slate-100 px-14 py-5 text-xl outline-none focus:border-emerald-500 focus:bg-white transition-all shadow-inner font-bold"
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                        />
                                        {isSearching && (
                                            <Loader2 className="absolute right-4 top-1/2 -translate-y-1/2 h-6 w-6 animate-spin text-emerald-500" />
                                        )}
                                    </div>

                                    <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                                        {foundSocios.map(socio => (
                                            <div key={socio.id} className="bg-white rounded-2xl p-5 border border-slate-100 flex items-center justify-between gap-6 hover:border-emerald-200 hover:shadow-md transition-all">
                                                <div className="flex items-center gap-4">
                                                    <div className="h-12 w-12 rounded-xl bg-slate-100 flex items-center justify-center">
                                                        <UserCircle2 className="h-7 w-7 text-slate-400" />
                                                    </div>
                                                    <div>
                                                        <p className="font-bold text-slate-800 text-lg line-clamp-1">{socio.nombreCompleto}</p>
                                                        <div className="flex gap-2 items-center text-xs text-slate-500 font-medium">
                                                            <span className="bg-slate-100 px-2 py-0.5 rounded italic"># {socio.numeroSocio}</span>
                                                            <span className="bg-slate-100 px-2 py-0.5 rounded">CI: {socio.cedula}</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="flex items-center gap-6">
                                                    {[
                                                        { label: "Aporte", field: "aporteAlDia" },
                                                        { label: "Solid.", field: "solidaridadAlDia" },
                                                        { label: "Fondo", field: "fondoAlDia" },
                                                        { label: "Incoop", field: "incoopAlDia" },
                                                        { label: "Cr√©dito", field: "creditoAlDia" }
                                                    ].map(item => (
                                                        <div key={item.field} className="flex flex-col items-center gap-2">
                                                            <span className="text-[9px] uppercase font-black text-slate-400">{item.label}</span>
                                                            <button
                                                                onClick={() => toggleStatus(socio.id, item.field, (socio as any)[item.field])}
                                                                className={`h-8 w-14 rounded-full p-1 transition-all flex items-center ${(socio as any)[item.field]
                                                                    ? 'bg-emerald-500'
                                                                    : 'bg-slate-200'
                                                                    } group relative`}
                                                                disabled={updatingSocioId === socio.id}
                                                            >
                                                                <div className={`h-6 w-6 rounded-full bg-white shadow flex items-center justify-center transition-all transform ${(socio as any)[item.field] ? 'translate-x-6' : 'translate-x-0'
                                                                    }`}>
                                                                    {(socio as any)[item.field] ? (
                                                                        <Check className="h-3 w-3 text-emerald-500" />
                                                                    ) : (
                                                                        <X className="h-3 w-3 text-slate-300" />
                                                                    )}
                                                                </div>
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </>
            )}
        </div>
    );
}

